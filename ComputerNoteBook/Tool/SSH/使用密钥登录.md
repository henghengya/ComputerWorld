---
title: 使用密钥登录
date: 2021-07-29 16:59:00
tags:
  - 
alias: 
category: 
stars: 
from: 
url: 
---

## 操作步骤

### 1. 制作密钥对

> 建议在客户端制作，我在服务端做的然后复制到Windows上后，会出现私钥失效，不知道是啥问题，可能是Windows与Linux的换行符不同，也可能是权限问题。

```bash
[root@host ~]$ ssh-keygen <== 建立密钥对 
Generating public/private rsa key pair. 
Enter file in which to save the key (/root/.ssh/id_rsa): <== 按 Enter 
Created directory '/root/.ssh'. Enter passphrase (empty for no passphrase): <== 输入密钥锁码，或直接按 Enter 留空 
Enter same passphrase again: <== 再输入一遍密钥锁码 
Your identification has been saved in /root/.ssh/id_rsa. <== 私钥 
Your public key has been saved in /root/.ssh/id_rsa.pub. <== 公钥 
The key fingerprint is: 
0f:d3:e7:1a:1c:bd:5c:03:f1:19:f1:22:df:9b:cc:08 root@host
```

密钥锁若设置，则在登录使用时必须输入密钥锁设置的密码。

### 2. 在服务器上安装公钥

```bash
cd ~/.ssh
echo 公钥信息 >> authorized_keys
```

为了设置成功，必须将文件的权限更改

```bash
chmod 600 authorized_keys
chmod 700 ~/.ssh
```

### 3. 打开SSH的密钥登陆功能

编辑/etc/ssh/sshd_config，添加或修改下面选项
```
RSAAuthentication yes
PubkeyAuthentication yes
```

留意root用户是否可以通过ssh登录
```
PerimtRootLogin yes
```

当完成全部设置，并且**使用密钥登录成功一次后**，一定要使用密钥登录成功后，再将禁用密码登录

```
PasswordAuthentication no
```

最后重启ssh服务

### 4. 使用私钥登录

```
ssh -i "私钥地址" user@loclhost
```

## 问题

### 1. 在Windows平台使用WSL通过私钥登录时，SSH提示私钥文件权限太开放，私钥不生效
```
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
Permissions 0777 for '/mnt/.../config/SSH/RSA' are too open.
It is required that your private key files are NOT accessible by others.
This private key will be ignored.
Load key "/mnt/.../config/SSH/RSA": bad permissions
```

在[Microsoft的文档](https://docs.microsoft.com/zh-cn/windows/wsl/troubleshooting#correct-ssh-related-permission-errors)中这样解决的：

将下面的内容追加到`/etc/wsl.conf`中：
```Bash
[automount]
enabled = true
options = metadata,uid=1000,gid=1000,umask=0022
```

这个问题其实涉及到了Windows文件在WSL系统中权限和Windows文件在Windows系统中的权限两个方面，更主要的是Windows文件在WSL系统中的权限转化。更多详情参考：[WSL的文件系统权限](https://docs.microsoft.com/zh-cn/windows/wsl/file-permissions)